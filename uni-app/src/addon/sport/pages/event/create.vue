<template>
    <view class="create-event-page">
        <!-- Ë°®ÂçïÂÜÖÂÆπ -->
        <view class="form-container">
            <view class="form-wrapper">
                <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                <view class="form-section">
                    <view class="section-title">Âü∫Êú¨‰ø°ÊÅØ</view>
                    
                    <!-- ÊØîËµõÂêçÁß∞ -->
                    <view class="form-item">
                        <view class="form-label required">ÊØîËµõÂêçÁß∞</view>
                        <input 
                            class="form-input" 
                            v-model="formData.name" 
                            placeholder="ËØ∑ËæìÂÖ•ÊØîËµõÂêçÁß∞"
                            maxlength="100"
                        />
                    </view>
                    
                    <!-- ‰∏æÂäûÂú∞ÁÇπ - Âú∞ÂõæÈÄâÊã© -->
                    <view class="form-item">
                        <view class="form-label required">ÈÄâÊã©Âú∞ÁÇπ</view>
                        <view class="location-container">
                            <input 
                                class="form-input readonly" 
                                :value="formData.location || ''" 
                                placeholder="ÁÇπÂáªÂú∞ÂõæÈÄâÊã©Âú∞ÁÇπ"
                                disabled
                                @tap="chooseLocation"
                            />
                            <view class="location-action" @tap="chooseLocation">
                                <text class="location-icon">üìç</text>
                                <text class="location-text">Âú∞ÂõæÈÄâÊã©</text>
                            </view>
                        </view>
                    </view>
                    
                    <!-- ‰∏æÂäûÂú∞ÁÇπ - ÊâãÂä®ËæìÂÖ• -->
                    <view class="form-item">
                        <view class="form-label required">ËØ¶ÁªÜÂú∞ÂùÄ</view>
                        <input 
                            class="form-input" 
                            v-model="formData.address_detail" 
                            placeholder="ËØ∑ËæìÂÖ•ËØ¶ÁªÜÂú∞ÂùÄÔºàÂ¶ÇÔºöxxÊ•ºxxÂÆ§Ôºâ"
                            maxlength="200"
                        />
                        <view class="form-tip">
                            <text class="tip-text">ÂÖàÈÄâÊã©Âú∞Âõæ‰ΩçÁΩÆÔºåÂÜçË°•ÂÖÖËØ¶ÁªÜÂú∞ÂùÄ‰ø°ÊÅØ</text>
                        </view>
                    </view>
                    
                    <!-- ÂºÄÂßãÊó∂Èó¥ -->
                    <view class="form-item">
                        <view class="form-label required">ÂºÄÂßãÊó∂Èó¥</view>
                        <view class="time-picker-container">
                            <picker
                                mode="date"
                                :value="startDateValue"
                                @change="onStartDateChange"
                            >
                                <view class="time-picker-item">
                                    <input 
                                        class="form-input readonly" 
                                        :value="startDateDisplay" 
                                        placeholder="ÈÄâÊã©Êó•Êúü"
                                        disabled
                                    />
                                    <text class="picker-arrow">üìÖ</text>
                                </view>
                            </picker>
                            <picker
                                mode="time"
                                :value="startTimeValue"
                                @change="onStartTimeChange"
                            >
                                <view class="time-picker-item">
                                    <input 
                                        class="form-input readonly" 
                                        :value="startTimeDisplay" 
                                        placeholder="ÈÄâÊã©Êó∂Èó¥"
                                        disabled
                                    />
                                    <text class="picker-arrow">üïê</text>
                                </view>
                            </picker>
                        </view>
                    </view>
                    
                    <!-- ÁªìÊùüÊó∂Èó¥ -->
                    <view class="form-item">
                        <view class="form-label required">ÁªìÊùüÊó∂Èó¥</view>
                        <view class="time-picker-container">
                            <picker
                                mode="date"
                                :value="endDateValue"
                                @change="onEndDateChange"
                            >
                                <view class="time-picker-item">
                                    <input 
                                        class="form-input readonly" 
                                        :value="endDateDisplay" 
                                        placeholder="ÈÄâÊã©Êó•Êúü"
                                        disabled
                                    />
                                    <text class="picker-arrow">üìÖ</text>
                                </view>
                            </picker>
                            <picker
                                mode="time"
                                :value="endTimeValue"
                                @change="onEndTimeChange"
                            >
                                <view class="time-picker-item">
                                    <input 
                                        class="form-input readonly" 
                                        :value="endTimeDisplay" 
                                        placeholder="ÈÄâÊã©Êó∂Èó¥"
                                        disabled
                                    />
                                    <text class="picker-arrow">üïê</text>
                                </view>
                            </picker>
                        </view>
                    </view>
                </view>
                
                <!-- ÁªÑÁªá‰ø°ÊÅØ -->
                <view class="form-section">
                    <view class="section-title">ÁªÑÁªá‰ø°ÊÅØ</view>
                    
                    <!-- ‰∏æÂäûËÄÖÁ±ªÂûã -->
                    <view class="form-item">
                        <view class="form-label required">‰∏æÂäûËÄÖÁ±ªÂûã</view>
                        <view class="radio-group">
                            <view 
                                v-for="item in organizerTypeOptions" 
                                :key="item.value" 
                                class="radio-item"
                                @tap="handleOrganizerTypeChange(item.value)"
                            >
                                <view class="radio-circle" :class="{ 'active': formData.organizer_type === item.value }">
                                    <view class="radio-dot" v-if="formData.organizer_type === item.value"></view>
                                </view>
                                <text class="radio-label">{{ item.label }}</text>
                            </view>
                        </view>
                    </view>
                    
                    <!-- ‰∏ªÂäûÊñπ -->
                    <view class="form-item">
                        <view class="form-label required">‰∏ªÂäûÊñπ</view>
                        <input 
                            class="form-input readonly" 
                            :value="selectedOrganizerName" 
                            placeholder="ËØ∑ÈÄâÊã©‰∏ªÂäûÊñπ"
                            disabled
                            @tap="openOrganizerPicker"
                        />
                        <view class="form-tip">
                            <text class="tip-text" v-if="!organizerList.length">ÊöÇÊó†‰∏ªÂäûÊñπÔºå</text>
                            <text class="tip-link" @tap="showOrganizerModal = true">
                                {{ organizerList.length ? 'Ê∑ªÂä†Êñ∞‰∏ªÂäûÊñπ' : 'ÁÇπÂáªÊ∑ªÂä†' }}
                            </text>
                        </view>
                    </view>
                </view>
                
                <!-- Á≥ªÂàóËµõËÆæÁΩÆ -->
                <view class="form-section">
                    <view class="section-title">Á≥ªÂàóËµõËÆæÁΩÆ</view>
                    
                    <!-- ÊòØÂê¶Á≥ªÂàóËµõ -->
                    <view class="form-item">
                        <view class="form-label">Ëµõ‰∫ãÁ±ªÂûã</view>
                        <view class="radio-group">
                            <view 
                                v-for="item in eventTypeOptions" 
                                :key="item.value" 
                                class="radio-item"
                                @tap="handleEventTypeChange(item.value)"
                            >
                                <view class="radio-circle" :class="{ 'active': formData.event_type === item.value }">
                                    <view class="radio-dot" v-if="formData.event_type === item.value"></view>
                                </view>
                                <text class="radio-label">{{ item.label }}</text>
                            </view>
                        </view>
                    </view>
                    
                    <!-- Á≥ªÂàóËµõÈÄâÊã© -->
                    <view 
                        v-if="formData.event_type === 2" 
                        class="form-item"
                    >
                        <view class="form-label required">Á≥ªÂàóËµõ</view>
                        <input 
                            class="form-input readonly" 
                            :value="selectedSeriesName" 
                            placeholder="ËØ∑ÈÄâÊã©Á≥ªÂàóËµõ"
                            disabled
                            @tap="openSeriesPicker"
                        />
                        <view class="form-tip">
                            <text class="tip-text" v-if="!seriesList.length">ÊöÇÊó†Á≥ªÂàóËµõÔºå</text>
                            <text class="tip-link" @tap="showSeriesModal = true">
                                {{ seriesList.length ? 'Ê∑ªÂä†Êñ∞Á≥ªÂàóËµõ' : 'ÁÇπÂáªÊ∑ªÂä†' }}
                            </text>
                        </view>
                    </view>
                </view>
            </view>
            
            <!-- Êèê‰∫§ÊåâÈíÆ -->
            <view class="submit-section">
                <button 
                    class="submit-btn" 
                    :class="{ 'loading': submitLoading }"
                    :disabled="submitLoading"
                    @tap="handleSubmit"
                >
                    {{ submitLoading ? 'ÂàõÂª∫‰∏≠...' : 'ÂàõÂª∫ÊØîËµõ' }}
                </button>
            </view>
        </view>
        

        
        <!-- ‰∏ªÂäûÊñπÈÄâÊã©Âô® -->
        <view v-if="showOrganizerPicker" class="picker-mask" @tap="showOrganizerPicker = false">
            <view class="picker-container" @tap.stop>
                <view class="picker-header">
                    <text class="picker-cancel" @tap="showOrganizerPicker = false">ÂèñÊ∂à</text>
                    <text class="picker-title">ÈÄâÊã©‰∏ªÂäûÊñπ</text>
                    <text class="picker-confirm" @tap="confirmOrganizerSelection">Á°ÆÂÆö</text>
                </view>
                <picker-view class="picker-view" :value="[selectedOrganizerIndex]" @change="onOrganizerPickerChange">
                    <picker-view-column>
                        <view v-for="(item, index) in organizerPickerList" :key="index" class="picker-item">
                            {{ item.organizer_name }}
                        </view>
                    </picker-view-column>
                </picker-view>
            </view>
        </view>
        
        <!-- Á≥ªÂàóËµõÈÄâÊã©Âô® -->
        <view v-if="showSeriesPicker" class="picker-mask" @tap="showSeriesPicker = false">
            <view class="picker-container" @tap.stop>
                <view class="picker-header">
                    <text class="picker-cancel" @tap="showSeriesPicker = false">ÂèñÊ∂à</text>
                    <text class="picker-title">ÈÄâÊã©Á≥ªÂàóËµõ</text>
                    <text class="picker-confirm" @tap="confirmSeriesSelection">Á°ÆÂÆö</text>
                </view>
                <picker-view class="picker-view" :value="[selectedSeriesIndex]" @change="onSeriesPickerChange">
                    <picker-view-column>
                        <view v-for="(item, index) in seriesPickerList" :key="index" class="picker-item">
                            {{ item.name }}
                        </view>
                    </picker-view-column>
                </picker-view>
            </view>
        </view>
        
        <!-- Ê∑ªÂä†‰∏ªÂäûÊñπÊ®°ÊÄÅÊ°Ü -->
        <view v-if="showOrganizerModal" class="modal-mask" @tap="cancelOrganizerModal">
            <view class="modal-container" @tap.stop>
                <view class="modal-header">
                    <text class="modal-title">Ê∑ªÂä†‰∏ªÂäûÊñπ</text>
                    <text class="modal-close" @tap="cancelOrganizerModal">√ó</text>
                </view>
                <view class="modal-content">
                    <view class="form-item">
                        <view class="form-label required">ÂêçÁß∞</view>
                        <input 
                            class="form-input" 
                            v-model="organizerForm.organizer_name" 
                            placeholder="ËØ∑ËæìÂÖ•‰∏ªÂäûÊñπÂêçÁß∞"
                            maxlength="100"
                        />
                    </view>
                    <view class="form-item">
                        <view class="form-label">ËÅîÁ≥ª‰∫∫</view>
                        <input 
                            class="form-input" 
                            v-model="organizerForm.contact_name" 
                            placeholder="ËØ∑ËæìÂÖ•ËÅîÁ≥ª‰∫∫"
                            maxlength="50"
                        />
                    </view>
                    <view class="form-item">
                        <view class="form-label">ËÅîÁ≥ªÁîµËØù</view>
                        <input 
                            class="form-input" 
                            v-model="organizerForm.contact_phone" 
                            placeholder="ËØ∑ËæìÂÖ•ËÅîÁ≥ªÁîµËØù"
                            maxlength="20"
                        />
                    </view>
                </view>
                <view class="modal-footer">
                    <button class="modal-btn cancel" @tap="cancelOrganizerModal">ÂèñÊ∂à</button>
                    <button class="modal-btn confirm" @tap="addOrganizerConfirm">Á°ÆÂÆö</button>
                </view>
            </view>
        </view>
        
        <!-- Ê∑ªÂä†Á≥ªÂàóËµõÊ®°ÊÄÅÊ°Ü -->
        <view v-if="showSeriesModal" class="modal-mask" @tap="cancelSeriesModal">
            <view class="modal-container" @tap.stop>
                <view class="modal-header">
                    <text class="modal-title">Ê∑ªÂä†Á≥ªÂàóËµõ</text>
                    <text class="modal-close" @tap="cancelSeriesModal">√ó</text>
                </view>
                <view class="modal-content">
                    <view class="form-item">
                        <view class="form-label required">Á≥ªÂàóËµõÂêçÁß∞</view>
                        <input 
                            class="form-input" 
                            v-model="seriesForm.name" 
                            placeholder="ËØ∑ËæìÂÖ•Á≥ªÂàóËµõÂêçÁß∞"
                            maxlength="100"
                        />
                    </view>
                    <view class="form-item">
                        <view class="form-label required">ÂºÄÂßãÂπ¥‰ªΩ</view>
                        <input 
                            class="form-input" 
                            v-model="seriesForm.start_year" 
                            placeholder="ËØ∑ËæìÂÖ•ÂºÄÂßãÂπ¥‰ªΩ"
                            type="number"
                        />
                    </view>
                    <view class="form-item">
                        <view class="form-label">ÊèèËø∞</view>
                        <textarea 
                            class="form-textarea" 
                            v-model="seriesForm.description" 
                            placeholder="ËØ∑ËæìÂÖ•Á≥ªÂàóËµõÊèèËø∞"
                            maxlength="200"
                        />
                    </view>
                </view>
                <view class="modal-footer">
                    <button class="modal-btn cancel" @tap="cancelSeriesModal">ÂèñÊ∂à</button>
                    <button class="modal-btn confirm" @tap="addSeriesConfirm">Á°ÆÂÆö</button>
                </view>
            </view>
        </view>
    </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useLoginCheck } from '@/addon/sport/hooks/useLoginCheck'
import { 
    addEvent, 
    getOrganizerList, 
    addOrganizer, 
    getEventSeriesList, 
    addEventSeries
} from '@/addon/sport/api/event'

// ÁôªÂΩïÊ£ÄÊü•
const { requireLogin } = useLoginCheck()

// Ë°®ÂçïÊï∞ÊçÆ
const formData = ref({
    name: '',                   // ÊØîËµõÂêçÁß∞
    location: '',              // ‰∏æÂäûÂú∞ÁÇπÔºàÂú∞ÂõæÈÄâÊã©ÁöÑÂú∞ÂùÄÂêçÁß∞Ôºâ
    lng: '',                   // ÁªèÂ∫¶
    lat: '',                   // Á∫¨Â∫¶
    full_address: '',          // ÂÆåÊï¥Âú∞ÂùÄ
    address_detail: '',        // Âú∞ÂùÄË°•ÂÖÖ
    start_time: 0,             // ÂºÄÂßãÊó∂Èó¥
    end_time: 0,               // ÁªìÊùüÊó∂Èó¥
    organizer_type: 1,         // ‰∏æÂäûËÄÖÁ±ªÂûãÔºö1‰∏™‰∫∫ 2Âçï‰Ωç
    organizer_id: 0,           // ‰∏ªÂäûÊñπID
    event_type: 1,             // Ëµõ‰∫ãÁ±ªÂûãÔºö1Áã¨Á´ãËµõ‰∫ã 2Á≥ªÂàóËµõ‰∫ã
    series_id: 0,              // Á≥ªÂàóËµõID
    year: new Date().getFullYear() // ‰∏æÂäûÂπ¥‰ªΩ
})

// ‰∏ªÂäûÊñπË°®Âçï
const organizerForm = ref({
    organizer_name: '',
    contact_name: '',
    contact_phone: '',
    organizer_type: 1
})

// Á≥ªÂàóËµõË°®Âçï
const seriesForm = ref({
    name: '',
    start_year: new Date().getFullYear(),
    description: ''
})

// ÈÄâÈ°πÊï∞ÊçÆ
const organizerTypeOptions = [
    { label: '‰∏™‰∫∫', value: 1 },
    { label: 'Âçï‰Ωç', value: 2 }
]

const eventTypeOptions = [
    { label: 'Áã¨Á´ãËµõ‰∫ã', value: 1 },
    { label: 'Á≥ªÂàóËµõ‰∫ã', value: 2 }
]

// Êó∂Èó¥Áõ∏ÂÖ≥
const startDateValue = ref('')
const startTimeValue = ref('')
const endDateValue = ref('')
const endTimeValue = ref('')

// ÊòæÁ§∫Áî®ÁöÑËÆ°ÁÆóÂ±ûÊÄß
const startDateDisplay = computed(() => {
    return startDateValue.value || ''
})

const startTimeDisplay = computed(() => {
    return startTimeValue.value || ''
})

const endDateDisplay = computed(() => {
    return endDateValue.value || ''
})

const endTimeDisplay = computed(() => {
    return endTimeValue.value || ''
})

// ÈÄâÊã©Âô®Áõ∏ÂÖ≥
const showOrganizerPicker = ref(false)
const showSeriesPicker = ref(false)
const showOrganizerModal = ref(false)
const showSeriesModal = ref(false)

// Êï∞ÊçÆÂàóË°®
const organizerList = ref<any[]>([])
const seriesList = ref<any[]>([])

// ÈÄâÊã©Âô®Êï∞ÊçÆ
const organizerPickerList = computed(() => {
    return organizerList.value
})

const seriesPickerList = computed(() => {
    return seriesList.value
})

// ÈÄâÊã©Âô®‰∏¥Êó∂Á¥¢Âºï
const tempOrganizerIndex = ref(0)
const tempSeriesIndex = ref(0)

// ÈÄâ‰∏≠ÁöÑÁ¥¢Âºï
const selectedOrganizerIndex = computed(() => {
    const index = organizerList.value.findIndex((item: any) => item.id === formData.value.organizer_id)
    return index >= 0 ? index : 0
})

const selectedSeriesIndex = computed(() => {
    const index = seriesList.value.findIndex((item: any) => item.id === formData.value.series_id)
    return index >= 0 ? index : 0
})

// ÈÄâ‰∏≠ÁöÑÊòæÁ§∫ÂêçÁß∞
const selectedOrganizerName = computed(() => {
    const organizer = organizerList.value.find((item: any) => item.id === formData.value.organizer_id)
    return organizer ? organizer.organizer_name : ''
})

const selectedSeriesName = computed(() => {
    const series = seriesList.value.find((item: any) => item.id === formData.value.series_id)
    return series ? series.name : ''
})

// Êèê‰∫§Áä∂ÊÄÅ
const submitLoading = ref(false)

/**
 * Êó•ÊúüÊó∂Èó¥ÈÄâÊã©
 */
const onStartDateChange = (e: any) => {
    console.log('ÂºÄÂßãÊó•ÊúüÈÄâÊã©:', e.detail.value)
    startDateValue.value = e.detail.value
    updateStartDateTime()
}

const onStartTimeChange = (e: any) => {
    console.log('ÂºÄÂßãÊó∂Èó¥ÈÄâÊã©:', e.detail.value)
    startTimeValue.value = e.detail.value
    updateStartDateTime()
}

const onEndDateChange = (e: any) => {
    console.log('ÁªìÊùüÊó•ÊúüÈÄâÊã©:', e.detail.value)
    endDateValue.value = e.detail.value
    updateEndDateTime()
}

const onEndTimeChange = (e: any) => {
    console.log('ÁªìÊùüÊó∂Èó¥ÈÄâÊã©:', e.detail.value)
    endTimeValue.value = e.detail.value
    updateEndDateTime()
}

/**
 * Êõ¥Êñ∞ÂºÄÂßãÊó∂Èó¥Êà≥
 */
const updateStartDateTime = () => {
    if (startDateValue.value && startTimeValue.value) {
        const dateTimeString = `${startDateValue.value} ${startTimeValue.value}`
        const timestamp = new Date(dateTimeString).getTime()
        formData.value.start_time = Math.floor(timestamp / 1000)
        formData.value.year = new Date(timestamp).getFullYear()
        
        console.log('ÂºÄÂßãÊó∂Èó¥Êõ¥Êñ∞:', {
            date: startDateValue.value,
            time: startTimeValue.value,
            timestamp: formData.value.start_time,
            year: formData.value.year
        })
    }
}

/**
 * Êõ¥Êñ∞ÁªìÊùüÊó∂Èó¥Êà≥
 */
const updateEndDateTime = () => {
    if (endDateValue.value && endTimeValue.value) {
        const dateTimeString = `${endDateValue.value} ${endTimeValue.value}`
        const timestamp = new Date(dateTimeString).getTime()
        formData.value.end_time = Math.floor(timestamp / 1000)
        
        console.log('ÁªìÊùüÊó∂Èó¥Êõ¥Êñ∞:', {
            date: endDateValue.value,
            time: endTimeValue.value,
            timestamp: formData.value.end_time
        })
    }
}

/**
 * ÈÄâÊã©Âú∞ÂùÄ
 */
const chooseLocation = () => {
    console.log('ÂºÄÂßãÈÄâÊã©Âú∞ÂùÄ')
    
    // #ifdef MP-WEIXIN
    uni.chooseLocation({
        success: (res) => {
            console.log('ÈÄâÊã©Âú∞ÂùÄÊàêÂäü:', res)
            
            // ‰øùÂ≠òÁªèÁ∫¨Â∫¶
            if (res.latitude && res.longitude) {
                formData.value.lat = res.latitude.toString()
                formData.value.lng = res.longitude.toString()
                console.log('ÁªèÁ∫¨Â∫¶‰øùÂ≠ò:', { lat: formData.value.lat, lng: formData.value.lng })
            }
            
            // ‰øùÂ≠òÂú∞ÂùÄ‰ø°ÊÅØ
            let locationName = ''
            if (res.address) {
                locationName = res.address
            }
            if (res.name && res.name !== res.address) {
                locationName += (locationName ? ' ' : '') + res.name
            }
            
            formData.value.location = locationName || res.name || 'Â∑≤ÈÄâÊã©‰ΩçÁΩÆ'
            
            // ÁªÑÂêàÂÆåÊï¥Âú∞ÂùÄÁî®‰∫éÊèê‰∫§
            formData.value.full_address = locationName
            
            console.log('Âú∞ÂùÄ‰ø°ÊÅØ‰øùÂ≠ò:', {
                location: formData.value.location,
                full_address: formData.value.full_address
            })
            
            uni.showToast({
                title: 'Âú∞ÂùÄÈÄâÊã©ÊàêÂäü',
                icon: 'success'
            })
        },
        fail: (res) => {
            console.error('ÈÄâÊã©Âú∞ÂùÄÂ§±Ë¥•:', res)
            if (res.errMsg && res.errMsg.includes('cancel')) {
                console.log('Áî®Êà∑ÂèñÊ∂àÈÄâÊã©Âú∞ÂùÄ')
                return
            }
            
            let message = 'ÈÄâÊã©Âú∞ÂùÄÂ§±Ë¥•'
            if (res.errMsg) {
                console.log('ÈîôËØØ‰ø°ÊÅØ:', res.errMsg)
                if (res.errMsg.includes('auth deny') || res.errMsg.includes('unauthorized')) {
                    message = 'ËØ∑ÊéàÊùÉÂú∞ÁêÜ‰ΩçÁΩÆÊùÉÈôê'
                } else if (res.errMsg.includes('system permission denied')) {
                    message = 'Á≥ªÁªüÊùÉÈôêË¢´ÊãíÁªùÔºåËØ∑Âú®Á≥ªÁªüËÆæÁΩÆ‰∏≠ÂºÄÂêØÂÆö‰ΩçÊùÉÈôê'
                }
            }
            
            uni.showToast({
                title: message,
                icon: 'none'
            })
        }
    })
    // #endif
    
    // #ifdef H5
    console.log('ÂΩìÂâçÁéØÂ¢É: H5')
    uni.showToast({
        title: 'H5ÁéØÂ¢ÉÊöÇ‰∏çÊîØÊåÅÂú∞ÂõæÈÄâÊã©ÔºåËØ∑ÊâãÂä®ËæìÂÖ•Âú∞ÂùÄ',
        icon: 'none'
    })
    // #endif
    
    // #ifdef APP-PLUS
    console.log('ÂΩìÂâçÁéØÂ¢É: APP')
    uni.showToast({
        title: 'APPÁéØÂ¢ÉÊöÇ‰∏çÊîØÊåÅÂú∞ÂõæÈÄâÊã©ÔºåËØ∑ÊâãÂä®ËæìÂÖ•Âú∞ÂùÄ',
        icon: 'none'
    })
    // #endif
}

/**
 * ‰∏æÂäûËÄÖÁ±ªÂûãÂèòÂåñ
 */
const handleOrganizerTypeChange = (value: number) => {
    formData.value.organizer_type = value
    formData.value.organizer_id = 0
    organizerForm.value.organizer_type = value
    loadOrganizerList()
}

/**
 * Ëµõ‰∫ãÁ±ªÂûãÂèòÂåñ
 */
const handleEventTypeChange = (value: number) => {
    formData.value.event_type = value
    if (value === 1) {
        formData.value.series_id = 0
    }
}

/**
 * ÊâìÂºÄÈÄâÊã©Âô®
 */
const openOrganizerPicker = () => {
    if (!organizerList.value.length) {
        uni.showToast({
            title: 'ÊöÇÊó†‰∏ªÂäûÊñπÊï∞ÊçÆ',
            icon: 'none'
        })
        return
    }
    tempOrganizerIndex.value = selectedOrganizerIndex.value
    showOrganizerPicker.value = true
}

const openSeriesPicker = () => {
    if (!seriesList.value.length) {
        uni.showToast({
            title: 'ÊöÇÊó†Á≥ªÂàóËµõÊï∞ÊçÆ',
            icon: 'none'
        })
        return
    }
    tempSeriesIndex.value = selectedSeriesIndex.value
    showSeriesPicker.value = true
}

/**
 * ÈÄâÊã©Âô®ÂèòÂåñ
 */
const onOrganizerPickerChange = (e: any) => {
    tempOrganizerIndex.value = e.detail.value[0]
}

const onSeriesPickerChange = (e: any) => {
    tempSeriesIndex.value = e.detail.value[0]
}

const confirmOrganizerSelection = () => {
    if (organizerPickerList.value[tempOrganizerIndex.value]) {
        const selected = organizerPickerList.value[tempOrganizerIndex.value]
        formData.value.organizer_id = selected.id
    }
    showOrganizerPicker.value = false
}

const confirmSeriesSelection = () => {
    if (seriesPickerList.value[tempSeriesIndex.value]) {
        const selected = seriesPickerList.value[tempSeriesIndex.value]
        formData.value.series_id = selected.id
    }
    showSeriesPicker.value = false
}

/**
 * Âä†ËΩΩ‰∏ªÂäûÊñπÂàóË°®
 */
const loadOrganizerList = async () => {
    try {
        const response: any = await getOrganizerList(formData.value.organizer_type)
        organizerList.value = response.data || []
    } catch (error) {
        console.error('Âä†ËΩΩ‰∏ªÂäûÊñπÂàóË°®Â§±Ë¥•:', error)
        organizerList.value = []
    }
}

/**
 * Âä†ËΩΩÁ≥ªÂàóËµõÂàóË°®
 */
const loadSeriesList = async () => {
    try {
        const response: any = await getEventSeriesList()
        seriesList.value = response.data || []
    } catch (error) {
        console.error('Âä†ËΩΩÁ≥ªÂàóËµõÂàóË°®Â§±Ë¥•:', error)
        seriesList.value = []
    }
}

/**
 * Ê∑ªÂä†‰∏ªÂäûÊñπ
 */
const addOrganizerConfirm = async () => {
    if (!organizerForm.value.organizer_name.trim()) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•‰∏ªÂäûÊñπÂêçÁß∞',
            icon: 'none'
        })
        return
    }
    
    try {
        const params = {
            ...organizerForm.value,
            organizer_type: formData.value.organizer_type
        }
        const result: any = await addOrganizer(params)
        
        // ÈáçÊñ∞Âä†ËΩΩ‰∏ªÂäûÊñπÂàóË°®
        await loadOrganizerList()
        
        // Ëá™Âä®ÈÄâ‰∏≠Êñ∞Ê∑ªÂä†ÁöÑ‰∏ªÂäûÊñπ
        if (result && result.data && result.data.id) {
            formData.value.organizer_id = result.data.id
            console.log('Ëá™Âä®ÈÄâ‰∏≠Êñ∞Ê∑ªÂä†ÁöÑ‰∏ªÂäûÊñπ:', result.data.id)
        }
        
        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂπ∂ÈáçÁΩÆË°®Âçï
        showOrganizerModal.value = false
        organizerForm.value = {
            organizer_name: '',
            contact_name: '',
            contact_phone: '',
            organizer_type: 1
        }
        
        uni.showToast({
            title: 'Ê∑ªÂä†‰∏ªÂäûÊñπÊàêÂäü',
            icon: 'success'
        })
    } catch (error) {
        console.error('Ê∑ªÂä†‰∏ªÂäûÊñπÂ§±Ë¥•:', error)
    }
}

const cancelOrganizerModal = () => {
    showOrganizerModal.value = false
    organizerForm.value = {
        organizer_name: '',
        contact_name: '',
        contact_phone: '',
        organizer_type: 1
    }
}

/**
 * Ê∑ªÂä†Á≥ªÂàóËµõ
 */
const addSeriesConfirm = async () => {
    if (!seriesForm.value.name.trim()) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•Á≥ªÂàóËµõÂêçÁß∞',
            icon: 'none'
        })
        return
    }
    
    if (!seriesForm.value.start_year) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•ÂºÄÂßãÂπ¥‰ªΩ',
            icon: 'none'
        })
        return
    }
    
    try {
        const result: any = await addEventSeries(seriesForm.value)
        
        // ÈáçÊñ∞Âä†ËΩΩÁ≥ªÂàóËµõÂàóË°®
        await loadSeriesList()
        
        // Ëá™Âä®ÈÄâ‰∏≠Êñ∞Ê∑ªÂä†ÁöÑÁ≥ªÂàóËµõ
        if (result && result.data && result.data.id) {
            formData.value.series_id = result.data.id
            console.log('Ëá™Âä®ÈÄâ‰∏≠Êñ∞Ê∑ªÂä†ÁöÑÁ≥ªÂàóËµõ:', result.data.id)
        }
        
        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂπ∂ÈáçÁΩÆË°®Âçï
        showSeriesModal.value = false
        seriesForm.value = {
            name: '',
            start_year: new Date().getFullYear(),
            description: ''
        }
        
        uni.showToast({
            title: 'Ê∑ªÂä†Á≥ªÂàóËµõÊàêÂäü',
            icon: 'success'
        })
    } catch (error) {
        console.error('Ê∑ªÂä†Á≥ªÂàóËµõÂ§±Ë¥•:', error)
    }
}

const cancelSeriesModal = () => {
    showSeriesModal.value = false
    seriesForm.value = {
        name: '',
        start_year: new Date().getFullYear(),
        description: ''
    }
}

/**
 * Ë°®ÂçïÈ™åËØÅ
 */
const validateForm = () => {
    if (!formData.value.name.trim()) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•ÊØîËµõÂêçÁß∞',
            icon: 'none'
        })
        return false
    }
    
    if (!formData.value.location.trim()) {
        uni.showToast({
            title: 'ËØ∑ÂÖàÈÄâÊã©Âú∞Âõæ‰ΩçÁΩÆ',
            icon: 'none'
        })
        return false
    }
    
    if (!formData.value.address_detail.trim()) {
        uni.showToast({
            title: 'ËØ∑ËæìÂÖ•ËØ¶ÁªÜÂú∞ÂùÄ',
            icon: 'none'
        })
        return false
    }
    
    if (!formData.value.start_time) {
        uni.showToast({
            title: 'ËØ∑ÈÄâÊã©ÂºÄÂßãÊó∂Èó¥',
            icon: 'none'
        })
        return false
    }
    
    if (!formData.value.end_time) {
        uni.showToast({
            title: 'ËØ∑ÈÄâÊã©ÁªìÊùüÊó∂Èó¥',
            icon: 'none'
        })
        return false
    }
    
    if (formData.value.start_time >= formData.value.end_time) {
        uni.showToast({
            title: 'ÁªìÊùüÊó∂Èó¥ÂøÖÈ°ªÊôö‰∫éÂºÄÂßãÊó∂Èó¥',
            icon: 'none'
        })
        return false
    }
    
    if (!formData.value.organizer_id) {
        uni.showToast({
            title: 'ËØ∑ÈÄâÊã©‰∏ªÂäûÊñπ',
            icon: 'none'
        })
        return false
    }
    
    if (formData.value.event_type === 2 && !formData.value.series_id) {
        uni.showToast({
            title: 'ËØ∑ÈÄâÊã©Á≥ªÂàóËµõ',
            icon: 'none'
        })
        return false
    }
    
    return true
}

/**
 * Ë°®ÂçïÊèê‰∫§
 */
const handleSubmit = async () => {
    // È™åËØÅË°®Âçï
    if (!validateForm()) {
        return
    }
    
    try {
        submitLoading.value = true
        
        // ÁªÑÂêàÂÆåÊï¥Âú∞ÂùÄ‰ø°ÊÅØ
        let finalFullAddress = formData.value.full_address
        if (formData.value.address_detail) {
            finalFullAddress += (finalFullAddress ? ' ' : '') + formData.value.address_detail
        }
        
        // Êèê‰∫§Êï∞ÊçÆ
        const submitData = {
            ...formData.value,
            full_address: finalFullAddress
        }
        
        await addEvent(submitData)
        
        uni.showToast({
            title: 'ÂàõÂª∫ÊØîËµõÊàêÂäü',
            icon: 'success'
        })
        
        // Âª∂ËøüË∑≥ËΩ¨
        setTimeout(() => {
            uni.navigateBack()
        }, 1500)
        
    } catch (error) {
        console.error('ÂàõÂª∫ÊØîËµõÂ§±Ë¥•:', error)
    } finally {
        submitLoading.value = false
    }
}

/**
 * È°µÈù¢ÂàùÂßãÂåñ
 */
onMounted(() => {
    // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
    requireLogin(() => {
        // Â∑≤ÁôªÂΩïÔºåÂàùÂßãÂåñÊï∞ÊçÆ
        loadOrganizerList()
        loadSeriesList()
        
        // ÂàùÂßãÂåñÊó∂Èó¥ÈÄâÊã©Âô®ÁöÑÂÄºÔºàËÆæÁΩÆ‰∏∫ÂΩìÂâçÊó∂Èó¥Ôºâ
        const now = new Date()
        const today = now.toISOString().slice(0, 10) // YYYY-MM-DD
        const currentTime = now.toTimeString().slice(0, 5) // HH:MM
        
        startDateValue.value = today
        startTimeValue.value = currentTime
        endDateValue.value = today
        endTimeValue.value = currentTime
        
        console.log('ÂàùÂßãÂåñÊó∂Èó¥ÈÄâÊã©Âô®:', {
            date: today,
            time: currentTime
        })
    }, '/addon/sport/pages/event/create')
})
</script>

<style lang="scss" scoped>
.create-event-page {
    min-height: 100vh;
    background-color: #f8faff;
}

.form-container {
    padding: 32rpx;
}

.form-wrapper {
    margin-bottom: 120rpx;
}

.form-section {
    background: white;
    border-radius: 16rpx;
    margin-bottom: 32rpx;
    overflow: hidden;
    
    .section-title {
        padding: 32rpx 32rpx 16rpx;
        font-size: 32rpx;
        font-weight: bold;
        color: #333;
        border-bottom: 1px solid #f0f0f0;
    }
}

.form-item {
    padding: 24rpx 32rpx;
    border-bottom: 1px solid #f8f8f8;
    
    &:last-child {
        border-bottom: none;
    }
    
    .form-label {
        font-size: 28rpx;
        color: #333;
        margin-bottom: 16rpx;
        
        &.required::after {
            content: '*';
            color: #ff4757;
            margin-left: 4rpx;
        }
    }
    
    .form-input {
        width: 100%;
        padding: 20rpx 0;
        font-size: 28rpx;
        color: #333;
        border: none;
        outline: none;
        background: transparent;
        
        &.readonly {
            color: #666;
        }
        
        &::placeholder {
            color: #999;
        }
    }
    
    .form-textarea {
        width: 100%;
        min-height: 120rpx;
        padding: 20rpx 0;
        font-size: 28rpx;
        color: #333;
        border: none;
        outline: none;
        background: transparent;
        resize: none;
        
        &::placeholder {
            color: #999;
        }
    }
}

.location-container {
    display: flex;
    align-items: center;
    gap: 16rpx;
    
    .form-input {
        flex: 1;
    }
    
    .location-action {
        display: flex;
        align-items: center;
        gap: 8rpx;
        padding: 16rpx 24rpx;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12rpx;
        
        .location-icon {
            font-size: 24rpx;
        }
        
        .location-text {
            font-size: 24rpx;
            color: white;
        }
    }
}

.time-picker-container {
    display: flex;
    gap: 16rpx;
    
    .time-picker-item {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
        
        .form-input {
            flex: 1;
            padding-right: 40rpx;
        }
        
        .picker-arrow {
            position: absolute;
            right: 12rpx;
            font-size: 24rpx;
            color: #999;
        }
    }
}



.radio-group {
    display: flex;
    flex-direction: row;
    gap: 32rpx;
}

.radio-item {
    display: flex;
    align-items: center;
    cursor: pointer;
    
    .radio-circle {
        width: 32rpx;
        height: 32rpx;
        border: 2rpx solid #ddd;
        border-radius: 50%;
        margin-right: 16rpx;
        display: flex;
        align-items: center;
        justify-content: center;
        
        &.active {
            border-color: #007aff;
        }
        
        .radio-dot {
            width: 16rpx;
            height: 16rpx;
            background-color: #007aff;
            border-radius: 50%;
        }
    }
    
    .radio-label {
        font-size: 28rpx;
        color: #333;
    }
}

.form-tip {
    margin-top: 16rpx;
    font-size: 24rpx;
    color: #999;
    
    .tip-text {
        color: #999;
    }
    
    .tip-link {
        color: #007aff;
        text-decoration: underline;
    }
}

.submit-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 32rpx;
    background: white;
    border-top: 1px solid #f0f0f0;
    
    .submit-btn {
        width: 100%;
        height: 88rpx;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 44rpx;
        font-size: 32rpx;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        
        &.loading {
            opacity: 0.7;
        }
        
        &:disabled {
            opacity: 0.5;
        }
    }
}

.modal-mask {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 64rpx;
}

.modal-container {
    background: white;
    border-radius: 16rpx;
    width: 100%;
    max-width: 600rpx;
    max-height: 80vh;
    overflow: hidden;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 32rpx;
    border-bottom: 1px solid #f0f0f0;
    
    .modal-title {
        font-size: 32rpx;
        font-weight: bold;
        color: #333;
    }
    
    .modal-close {
        font-size: 48rpx;
        color: #999;
        cursor: pointer;
    }
}

.modal-content {
    padding: 32rpx;
    max-height: 50vh;
    overflow-y: auto;
}

.modal-footer {
    display: flex;
    border-top: 1px solid #f0f0f0;
    
    .modal-btn {
        flex: 1;
        height: 88rpx;
        border: none;
        font-size: 28rpx;
        cursor: pointer;
        
        &.cancel {
            background: #f8f8f8;
            color: #666;
        }
        
        &.confirm {
            background: #007aff;
            color: white;
        }
    }
}

.picker-mask {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    align-items: flex-end;
    justify-content: center;
}

.picker-container {
    background: white;
    width: 100%;
    border-radius: 24rpx 24rpx 0 0;
}

.picker-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 32rpx;
    border-bottom: 1px solid #f0f0f0;
    
    .picker-cancel,
    .picker-confirm {
        font-size: 28rpx;
        color: #007aff;
        cursor: pointer;
    }
    
    .picker-title {
        font-size: 32rpx;
        font-weight: bold;
        color: #333;
    }
}

.picker-view {
    height: 500rpx;
}

.picker-item {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100rpx;
    font-size: 28rpx;
    color: #333;
}
</style> 